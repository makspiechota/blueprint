type: user-story
id: claude-code-adapter
productName: test
version: '1.0'
last_updated: '2026-01-14'
name: Implement Claude Code adapter
description: >-
  As the system, I need to call Claude Code in headless mode,
  so that workflows can use Claude for code generation tasks.
status: planned
acceptance_criteria:
  - Calls Claude Code via `claude -p "prompt"` command
  - Supports --output-format stream-json for streaming output
  - Handles --allowedTools configuration from agent config
  - Parses streaming JSON output into AgentResult
  - Detects rate limit errors and marks them appropriately
  - Respects timeout and abort signal
tasks:
  - id: headless-invocation
    name: Implement Claude Code headless invocation
    description: Spawn claude process with -p flag, capture stdout/stderr
    status: planned
    estimate: 3h
  - id: stream-json-parsing
    name: Parse stream-json output format
    description: Parse streaming JSON chunks, emit output events, build final result
    status: planned
    estimate: 2h
  - id: tool-configuration
    name: Support allowedTools configuration
    description: Map agent config tools to --allowedTools flag values
    status: planned
    estimate: 1h
  - id: error-detection
    name: Detect and classify errors
    description: Parse error output, detect rate limits, permission errors, timeouts
    status: planned
    estimate: 2h
  - id: working-directory
    name: Handle working directory
    description: Execute Claude Code in correct working directory (target codebase)
    status: planned
    estimate: 1h
