# Task: Create Customer Factory Visualizer

## User Story Reference
- As a product manager, I want to see AAARR metrics with targets and current values so that I can identify the biggest gaps
- As a business analyst, I want to visualize the customer factory so that I can identify bottlenecks

## Description
Create HTML visualizer for AAARR metrics that displays the Customer Factory pipeline showing all 5 stages (Acquisition, Activation, Retention, Referral, Revenue) with their metrics, targets, current values, and gaps.

## Files to Modify/Create
- `src/visualizer/aaarr-visualizer.ts` - Create new visualizer module
- `tests/visualizer.test.ts` - Add unit tests

## Estimated Lines of Code
~180 lines (150 implementation + 30 tests)

## Dependencies
- Task 002: Types must be generated
- Task 004: Gap calculator must exist

## Implementation Notes

### Create Visualizer Module

Create `src/visualizer/aaarr-visualizer.ts`:

```typescript
import { AARRRMetrics } from '../parser/types';
import { calculateAllGaps, formatGap, isNegativeGap } from '../calculator/gap-calculator';

export function generateAARRRMetricsHTML(metrics: AARRRMetrics): string {
  const metricsWithGaps = calculateAllGaps(metrics);

  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${escapeHtml(metrics.title)} - AAARR Customer Factory</title>
  <style>
    ${getStyles()}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>${escapeHtml(metrics.title)}</h1>
      <div class="meta">
        <span>Version: ${escapeHtml(metrics.version)}</span>
        <span>Last Updated: ${escapeHtml(metrics.last_updated)}</span>
      </div>
    </header>

    <div class="customer-factory">
      ${renderPipeline(metricsWithGaps)}
    </div>

    <footer>
      <p>Generated by BLUEPRINT - Business Layer Architecture</p>
    </footer>
  </div>
</body>
</html>`;
}

function renderPipeline(metrics: AARRRMetrics): string {
  const stages = ['acquisition', 'activation', 'retention', 'referral', 'revenue'];
  const stageLabels = {
    acquisition: 'Acquisition',
    activation: 'Activation',
    retention: 'Retention',
    referral: 'Referral',
    revenue: 'Revenue'
  };

  return stages.map((stageName, index) => {
    const stage = metrics.stages[stageName];
    if (!stage) return '';

    const hasGaps = stage.metrics?.some(m =>
      m.gap && !isNegativeGap(m.gap) &&
      (m.gap.rate !== 0 || m.gap.amount !== 0 || m.gap.percentage !== 0)
    );

    return `
      <div class="stage ${hasGaps ? 'has-gaps' : 'on-track'}">
        <div class="stage-header">
          <h2>${stageLabels[stageName]}</h2>
          <p class="stage-goal">${escapeHtml(stage.stage_goal)}</p>
        </div>
        <div class="metrics">
          ${stage.metrics?.map(metric => renderMetric(metric)).join('') || ''}
        </div>
      </div>
      ${index < stages.length - 1 ? '<div class="connector">â†’</div>' : ''}
    `;
  }).join('');
}

function renderMetric(metric: any): string {
  const hasGap = metric.gap && !isNegativeGap(metric.gap);
  const gapClass = hasGap ? 'gap-exists' : 'on-track';

  return `
    <div class="metric ${gapClass}">
      <div class="metric-name">${escapeHtml(metric.name)}</div>
      ${metric.description ? `<div class="metric-description">${escapeHtml(metric.description)}</div>` : ''}

      <div class="metric-values">
        ${metric.target ? `
          <div class="value-row">
            <span class="label">Target:</span>
            <span class="value">${formatMetricValue(metric.target)}</span>
          </div>
        ` : ''}

        ${metric.current ? `
          <div class="value-row">
            <span class="label">Current:</span>
            <span class="value">${formatMetricValue(metric.current)}</span>
          </div>
        ` : ''}

        ${metric.gap ? `
          <div class="value-row gap-row">
            <span class="label">Gap:</span>
            <span class="gap-value ${hasGap ? 'negative' : 'positive'}">${formatGap(metric.gap)}</span>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

function formatMetricValue(value: any): string {
  if (value.rate !== undefined && value.period) {
    return `${value.rate}/${value.period}`;
  }
  if (value.amount !== undefined && value.currency) {
    return `${value.currency} ${value.amount.toLocaleString()}`;
  }
  if (value.percentage !== undefined) {
    return `${value.percentage}%`;
  }
  return 'N/A';
}

function escapeHtml(text: string): string {
  const map: { [key: string]: string } = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

function getStyles(): string {
  return `
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
    }
    header {
      text-align: center;
      margin-bottom: 40px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 20px;
    }
    h1 { font-size: 2rem; color: #2c3e50; margin-bottom: 10px; }
    .meta { color: #7f8c8d; font-size: 0.9rem; }
    .customer-factory {
      display: flex;
      align-items: stretch;
      gap: 20px;
      margin: 30px 0;
      overflow-x: auto;
      padding: 20px 0;
    }
    .stage {
      flex: 1;
      min-width: 250px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      background: #fafafa;
      transition: all 0.3s;
    }
    .stage.has-gaps {
      border-color: #e74c3c;
      background: #fff5f5;
    }
    .stage.on-track {
      border-color: #27ae60;
      background: #f0fff4;
    }
    .stage-header {
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .stage-header h2 {
      font-size: 1.3rem;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    .stage-goal {
      font-size: 0.85rem;
      color: #7f8c8d;
      font-style: italic;
    }
    .connector {
      display: flex;
      align-items: center;
      font-size: 2rem;
      color: #95a5a6;
      font-weight: bold;
    }
    .metrics {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .metric {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 15px;
    }
    .metric.gap-exists {
      border-left: 4px solid #e74c3c;
    }
    .metric.on-track {
      border-left: 4px solid #27ae60;
    }
    .metric-name {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    .metric-description {
      font-size: 0.85rem;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    .metric-values {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .value-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    .label {
      color: #7f8c8d;
      font-weight: 500;
    }
    .value {
      color: #2c3e50;
      font-weight: 600;
    }
    .gap-row {
      margin-top: 5px;
      padding-top: 5px;
      border-top: 1px solid #e0e0e0;
    }
    .gap-value.negative {
      color: #e74c3c;
      font-weight: bold;
    }
    .gap-value.positive {
      color: #27ae60;
      font-weight: bold;
    }
    footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
      color: #95a5a6;
      font-size: 0.85rem;
    }
    @media (max-width: 768px) {
      .customer-factory {
        flex-direction: column;
      }
      .connector {
        transform: rotate(90deg);
        margin: 10px 0;
      }
    }
    @media print {
      body { background: white; padding: 0; }
      .container { box-shadow: none; }
    }
  `;
}
```

### Add Unit Tests

Add to `tests/visualizer.test.ts`:

```typescript
describe('generateAARRRMetricsHTML', () => {
  test('generates complete HTML with all 5 stages', () => {
    // Test with full AAARR metrics structure
  });

  test('displays metrics with targets, current, and gaps', () => {
    // Test metric value rendering
  });

  test('highlights stages with gaps', () => {
    // Test gap visualization
  });

  test('formats rate, amount, and percentage values correctly', () => {
    // Test value formatting
  });

  test('handles missing current or target values', () => {
    // Test partial data
  });
});
```

## Acceptance Criteria
- [ ] generateAARRRMetricsHTML function created
- [ ] All 5 AAARR stages rendered as pipeline
- [ ] Stages display horizontally with arrow connectors
- [ ] Each stage shows stage_goal
- [ ] Metrics display name, description, target, current, gap
- [ ] Gaps calculated and displayed with formatting
- [ ] Visual indication for stages with gaps (red border)
- [ ] Visual indication for on-track stages (green border)
- [ ] Responsive design (mobile: vertical stack)
- [ ] Print styles included
- [ ] Unit tests added
- [ ] All tests passing
- [ ] TypeScript compiles without errors
